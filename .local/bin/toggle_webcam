#!/usr/bin/env sh

pidfile=/tmp/$(basename $0).pid
if [ -f $pidfile ]
then
  pid=$(cat $pidfile)
  ps -p $pid > /dev/null && kill -USR1 $pid
  rm $pidfile
  if [ -n "$1" ]
  then
    $(basename $0) $1
  fi
  exit 0
fi

webcam=/dev/video0
bar_height=22
mpv_width=400
mpv_autofit=25%


open_webcam ()
{
  # geometry and position setup
  dir=$1
  if [ $dir != full ]
  then
    common=$(( $(bspc config window_gap) + $(bspc config border_width) ))
    case $dir in
      s*) dy=-$common ;;
      n*) dy=+$(($common+$bar_height)) ;;
    esac
    case $dir in
      *e) dx=-$common ;;
      *w) dx=+$common ;;
    esac

    gnp="--geometry=$mpv_width$dx$dy --autofit=$mpv_autofit"
  else
    gnp="--geometry=$(xrandr|grep '*'|awk -F' ' '{print $1}')"
  fi

  mpv $gnp --input-default-bindings=no --no-osc --demuxer-lavf-format video4linux2 --demuxer-lavf-o-set input_format=mjpeg av://v4l2:$webcam & echo $! > $pidfile
}


open_webcam ${1-'se'}
